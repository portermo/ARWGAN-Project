# 圖片資料集檢查工具說明

## 功能簡介

`check_dataset_images.py` 是一個強大的圖片檢查工具，可以：

✅ 檢查圖片是否損壞
✅ 驗證圖片格式和尺寸
✅ 測試圖片能否正常載入
✅ 檢查圖片能否轉換為訓練所需的格式
✅ 偵測異常圖片（全黑、全白、包含 NaN/Inf）
✅ 多進程並行處理，速度快
✅ 自動移除或移動損壞的圖片
✅ 生成詳細的檢查報告

---

## 安裝依賴

```bash
cd /mnt/nvme/p3/Project/arwgan/ARWGAN-Project/ARWGAN-main
source venv/bin/activate
pip install tqdm  # 如果尚未安裝
```

---

## 使用方法

### 1. 基本檢查

檢查整個資料集：

```bash
python check_dataset_images.py data/coco2017
```

輸出示例：
```
======================================================================
圖片資料集檢查工具
======================================================================

📁 檢查目錄: data/coco2017
🔍 搜尋圖片檔案...
✓ 找到 123,287 張圖片

🔬 檢查圖片 (使用 4 個進程)...
檢查進度: 100%|████████████████| 123287/123287 [05:23<00:00, 380.45張/s]

======================================================================
檢查結果
======================================================================

✅ 有效圖片: 123,250 張 (99.97%)
❌ 無效圖片: 37 張 (0.03%)
⚠️  警告圖片: 15 張 (0.01%)
```

### 2. 檢查特定目錄

只檢查驗證集：

```bash
python check_dataset_images.py data/coco2017/val
```

### 3. 使用多進程加速

使用 8 個進程並行處理：

```bash
python check_dataset_images.py data/coco2017 --workers 8
```

### 4. 儲存檢查報告

將結果儲存到文字檔：

```bash
python check_dataset_images.py data/coco2017 --save-report check_report.txt
```

### 5. 顯示詳細資訊

查看每張無效或警告圖片的詳細訊息：

```bash
python check_dataset_images.py data/coco2017 --verbose
```

### 6. 移除損壞的圖片

**⚠️ 注意：此操作會永久刪除檔案！**

```bash
python check_dataset_images.py data/coco2017 --remove-invalid
```

### 7. 移動損壞的圖片（推薦）

將損壞的圖片移到其他目錄保存：

```bash
python check_dataset_images.py data/coco2017 --move-invalid corrupted_images/
```

### 8. 自訂檢查參數

設定最小/最大尺寸和允許的圖片格式：

```bash
python check_dataset_images.py data/coco2017 \
    --min-size 64 \
    --max-size 8000 \
    --extensions .jpg .jpeg .png .webp
```

---

## 完整參數說明

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `directory` | 要檢查的資料集目錄（必填） | - |
| `--min-size` | 最小圖片尺寸（寬或高） | 32 |
| `--max-size` | 最大圖片尺寸（寬或高） | 10000 |
| `--extensions` | 要檢查的副檔名 | .jpg .jpeg .png |
| `--remove-invalid` | 刪除無效的圖片 | False |
| `--move-invalid DIR` | 將無效圖片移到指定目錄 | None |
| `--workers` | 並行處理的進程數 | 4 |
| `--save-report FILE` | 儲存檢查報告到檔案 | None |
| `--verbose` / `-v` | 顯示詳細資訊 | False |

---

## 檢查項目

工具會對每張圖片進行以下檢查：

### ✅ 必要檢查（影響有效性）

1. **檔案存在性** - 檢查檔案是否存在
2. **檔案大小** - 檔案大小不能為 0
3. **可讀性** - 嘗試打開並載入圖片
4. **尺寸檢查** - 檢查寬高是否符合最小尺寸要求
5. **RGB 轉換** - 檢查能否轉換為 RGB 格式
6. **Tensor 轉換** - 檢查能否轉換為 PyTorch tensor
7. **數值有效性** - 檢查是否包含 NaN 或 Inf

### ⚠️ 警告檢查（不影響有效性）

1. **圖片格式** - 格式是否在推薦列表中
2. **圖片過大** - 尺寸是否超過最大限制
3. **色彩模式** - 是否為標準色彩模式（RGB/L/RGBA）
4. **單一顏色** - 圖片是否為全黑或全白

---

## 常見錯誤類型

### 無法打開圖片

```
✗ 無法打開圖片: cannot identify image file
```

**原因**：檔案損壞或不是有效的圖片格式  
**解決**：移除或重新下載該圖片

### 圖片尺寸過小

```
✗ 圖片尺寸過小: 28x28 (最小: 32)
```

**原因**：圖片太小，不符合訓練要求  
**解決**：移除小圖片或調整 `--min-size` 參數

### 無法轉換為 RGB

```
✗ 無法轉換為 RGB: ...
```

**原因**：圖片色彩模式異常  
**解決**：移除該圖片

### 圖片包含 NaN 值

```
✗ 圖片包含 NaN 值
```

**原因**：圖片數據損壞  
**解決**：移除該圖片

---

## 使用範例

### 範例 1：快速檢查驗證集

```bash
# 使用 8 進程快速檢查驗證集
python check_dataset_images.py data/coco2017/val --workers 8
```

### 範例 2：完整檢查並生成報告

```bash
# 檢查整個資料集，生成詳細報告
python check_dataset_images.py data/coco2017 \
    --workers 8 \
    --verbose \
    --save-report full_check_report.txt
```

### 範例 3：清理損壞圖片

```bash
# 先檢查並移動損壞圖片到備份目錄
python check_dataset_images.py data/coco2017 \
    --move-invalid backup/corrupted/ \
    --workers 8 \
    --save-report cleanup_report.txt

# 確認無誤後，可以刪除備份目錄
# rm -rf backup/corrupted/
```

### 範例 4：訓練前檢查

```bash
# 訓練前建議執行的完整檢查
python check_dataset_images.py data/coco2017 \
    --min-size 32 \
    --max-size 10000 \
    --workers 8 \
    --move-invalid corrupted_images/ \
    --save-report pre_training_check.txt
```

---

## 效能參考

### 處理速度

| 進程數 | 圖片數 | 處理時間 | 速度 |
|--------|--------|----------|------|
| 1 | 5,000 | ~20 分鐘 | ~4 張/秒 |
| 4 | 5,000 | ~6 分鐘 | ~14 張/秒 |
| 8 | 5,000 | ~4 分鐘 | ~21 張/秒 |
| 8 | 123,287 | ~90 分鐘 | ~23 張/秒 |

**建議**：使用 `--workers 8` 可獲得最佳效能

### 記憶體使用

- 單進程：~500 MB
- 8 進程：~2-3 GB

---

## 檢查報告格式

生成的報告包含：

```
======================================================================
圖片資料集檢查報告
======================================================================

檢查目錄: data/coco2017
總圖片數: 123287
有效圖片: 123250
無效圖片: 37
警告圖片: 15

======================================================================
無效圖片清單
======================================================================

路徑: data/coco2017/train/images/broken_001.jpg
錯誤:
  - 無法打開圖片: cannot identify image file

路徑: data/coco2017/train/images/small_002.jpg
錯誤:
  - 圖片尺寸過小: 20x20 (最小: 32)

======================================================================
警告圖片清單
======================================================================

路徑: data/coco2017/val/images/large_001.jpg
警告:
  - 圖片尺寸過大: 12000x8000
資訊: {'format': 'JPEG', 'size': (12000, 8000), 'mode': 'RGB', 'file_size': 15728640}
```

---

## 常見問題 (FAQ)

### Q: 檢查需要多久時間？

**A**: 取決於圖片數量和進程數：
- 5,000 張圖片，8 進程：約 4 分鐘
- 123,287 張圖片，8 進程：約 90 分鐘

### Q: 會修改原始圖片嗎？

**A**: 不會！除非您使用 `--remove-invalid` 或 `--move-invalid` 參數，否則只會進行檢查，不會修改任何檔案。

### Q: 檢查時會佔用 GPU 嗎？

**A**: 不會。檢查過程只使用 CPU。

### Q: 如果發現損壞圖片該怎麼辦？

**A**: 建議先使用 `--move-invalid` 將損壞圖片移到備份目錄，確認無誤後再刪除。

### Q: 可以檢查符號連結（symlink）的圖片嗎？

**A**: 可以！工具會自動跟隨符號連結檢查實際圖片。

### Q: 檢查會影響訓練嗎？

**A**: 不會。可以在訓練進行時同時檢查其他資料集。

---

## 整合到訓練流程

建議在訓練前執行檢查：

```bash
#!/bin/bash
# train_with_check.sh

# 1. 檢查資料集
echo "檢查資料集..."
python check_dataset_images.py data/coco2017 \
    --workers 8 \
    --move-invalid corrupted_images/ \
    --save-report dataset_check.txt

# 2. 檢查結果
if [ $? -ne 0 ]; then
    echo "⚠️ 發現損壞的圖片，已移至 corrupted_images/"
    echo "請檢查 dataset_check.txt 了解詳情"
    read -p "是否繼續訓練？(y/N): " continue_train
    if [ "$continue_train" != "y" ]; then
        exit 1
    fi
fi

# 3. 開始訓練
echo "開始訓練..."
python main.py new -n my_experiment -d data/coco2017 -b 32 -e 100
```

---

## 技術細節

### 檢查方法

1. **PIL 載入測試** - 使用 `Image.open()` 和 `load()` 
2. **格式驗證** - 檢查 `img.format` 和 `img.mode`
3. **轉換測試** - 嘗試 `convert('RGB')` 
4. **Tensor 轉換** - 使用 `transforms.ToTensor()`
5. **數值檢查** - `torch.isnan()` 和 `torch.isinf()`

### 多進程實現

使用 Python `multiprocessing.Pool` 實現並行處理：
- 每個進程獨立檢查一批圖片
- 使用 `tqdm` 顯示即時進度
- 自動處理異常和錯誤

---

## 更新日誌

### v1.0 (2026-01-24)
- ✅ 初始版本發布
- ✅ 支援多進程處理
- ✅ 完整的檢查項目
- ✅ 報告生成功能
- ✅ 損壞圖片移除/移動功能

---

## 授權

本工具為 ARWGAN 專案的一部分，遵循專案的 LICENSE。

---

## 聯繫方式

如有問題或建議，請在 GitHub 上提交 Issue。
